# JPA 영속성 컨텍스트

## 정의
- EntityManager가 관리하는 1차 캐시로, 동일 트랜잭션 내 엔티티 동기화/변경 감지를 처리한다.
- 식별자(Primary Key) 기준으로 엔티티 인스턴스를 저장하며, 동일 키에 대해 단일 객체를 보장한다.

## 동작 단계
1. **`persist()`**: 새 엔티티를 컨텍스트에 등록, 즉시 INSERT 되지 않고 플러시 시점에 반영.
2. **조회**: 먼저 1차 캐시에서 찾고, 없으면 DB 조회 → 결과를 캐시에 저장.
3. **변경 감지 (Dirty Checking)**: 트랜잭션 종료/flush 시 스냅샷과 비교해 UPDATE SQL 생성.
4. **삭제**: `remove()` 호출 후 플러시 때 DELETE 실행.

## 특징
- 트랜잭션 범위에서 공유되며, 같은 `@Transactional` 내에서는 같은 컨텍스트를 사용한다.
- 지연 로딩 프록시도 컨텍스트를 통해 초기화되므로, 트랜잭션 종료 후에는 `LazyInitializationException` 가능.

## 실무 팁
- 서비스 계층에서 엔티티를 DTO로 변환해 컨텍스트 의존성을 줄인다.
- 대량 처리는 배치 크기를 지정해 `flush()`/`clear()` 를 주기적으로 호출해 메모리를 관리한다.
- 영속성 컨텍스트와 캐시 전략을 문서화하여 팀이 언제 detach/merge 를 써야 하는지 공유한다.
