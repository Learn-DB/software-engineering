# Locks

## 목적
- 동시성 환경에서 레코드나 리소스에 대한 배타적 접근을 보장해 데이터 무결성을 유지한다.
- 읽기/쓰기 작업 충돌을 조정해 트랜잭션이 고립된 상태처럼 동작하도록 돕는다.

## 잠금 유형
- **Shared (S Lock)**: 읽기 작업 전용, 서로 공유 가능하지만 쓰기와는 호환되지 않는다.
- **Exclusive (X Lock)**: 쓰기 작업에서 사용, 해당 리소스에 하나만 존재할 수 있다.
- **Intent Locks**: 상위 레벨 리소스에 설정해 하위 잠금 계획을 선언한다 (페이지/테이블 수준).
- **Update Lock**: 잠재적 쓰기 작업이 있을 때 데드락 확률을 줄이기 위해 사용한다 (MSSQL).

## 잠금 범위
- **Row-Level**: 세밀하지만 잠금 관리 비용 증가.
- **Page-Level**: 디스크 페이지 단위, 중간 수준의 경합/오버헤드.
- **Table-Level**: 관리 용이하지만 동시성 감소.
- 일부 시스템은 **Lock Escalation**으로 작은 잠금이 일정량 이상 쌓이면 더 큰 범위로 격상한다.

## 데드락 예방
- 항상 리소스를 동일한 순서로 잠근다.
- 타임아웃을 설정해 장시간 잠금이 시스템을 멈추게 하지 않는다.
- 긴 쿼리/배치 작업은 트래픽이 적은 시간대에 수행하고 모니터링을 강화한다.

## 모니터링 포인트
- `pg_locks`, `INNODB_LOCKS`, `sys.dm_tran_locks` 등 DB 별 뷰를 통해 잠금 대기 시간과 소유자를 추적한다.
- 평균 Lock Wait, Deadlock 발생 횟수, Escalation 빈도를 대시보드화해 병목을 발견한다.
